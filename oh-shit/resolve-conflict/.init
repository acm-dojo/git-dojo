#!/bin/bash

/mnt/sudo/setup.sh
/mnt/site-packages/setup_packages.sh

chmod +x /challenge/submit

cat > /tmp/git-setup.sh <<'EOF'
export PATH="/run/dojo/bin:$PATH"
set -euo pipefail
rm -rf /home/hacker/dojo-conflict
mkdir -p /home/hacker/dojo-conflict
cd /home/hacker/dojo-conflict

git init -b main >/dev/null
git config user.name "Git Dojo"
git config user.email "dojo@example.com"

cat <<'TXT' > story.txt
Chapter 1: Arrival
Chapter 2: Tension builds
Chapter 3: TBD
TXT

git add story.txt
GIT_AUTHOR_NAME="Git Dojo" GIT_AUTHOR_EMAIL="dojo@example.com" \
GIT_COMMITTER_NAME="Git Dojo" GIT_COMMITTER_EMAIL="dojo@example.com" \
  git commit -m "draft storyline" >/dev/null

git branch feature/story

git switch feature/story >/dev/null
cat <<'TXT2' > story.txt
Chapter 1: Arrival
Chapter 2: Tension builds
Chapter 3: Alternate timeline reveal.
Chapter 4: Cliffhanger
TXT2

git commit -am "feature: add alternate twist" >/dev/null

git switch main >/dev/null
cat <<'TXT3' > story.txt
Chapter 1: Arrival
Chapter 2: Tension builds
Chapter 3: Main timeline update.
TXT3

git commit -am "main: tighten chapter three" >/dev/null
EOF

su hacker /tmp/git-setup.sh

su hacker -c 'export PATH="/run/dojo/bin:$PATH"; cd /home/hacker/dojo-conflict && git rev-parse HEAD' > /challenge/.resolve_main_before_merge
su hacker -c 'export PATH="/run/dojo/bin:$PATH"; cd /home/hacker/dojo-conflict && git rev-parse feature/story' > /challenge/.resolve_feature_head
