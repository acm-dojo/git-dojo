#!/bin/bash

chmod +x /challenge/submit
export PATH="/run/dojo/bin:$PATH"

set -euo pipefail
rm -rf /home/hacker/dojo-conflict
mkdir -p /home/hacker/dojo-conflict
cd /home/hacker/dojo-conflict

git init -b main >/dev/null
git config user.name "hacker"
git config user.email "hacker@sjtu.edu.cn"

cat <<'TXT' > story.txt
Chapter 1: Arrival
Chapter 2: Tension builds
Chapter 3: TBD
TXT

git add story.txt
GIT_AUTHOR_NAME="hacker" GIT_AUTHOR_EMAIL="hacker@sjtu.edu.cn" \
GIT_COMMITTER_NAME="hacker" GIT_COMMITTER_EMAIL="hacker@sjtu.edu.cn" \
  git commit -m "draft storyline" >/dev/null

git branch feature/story

git switch feature/story >/dev/null
cat <<'TXT' > story.txt
Chapter 1: Arrival
Chapter 2: Tension builds
Chapter 3: Alternate timeline reveal.
Chapter 4: Cliffhanger
TXT

git commit -am "feature: add alternate twist" >/dev/null

git switch main >/dev/null
cat <<'TXT' > story.txt
Chapter 1: Arrival
Chapter 2: Tension builds
Chapter 3: Main timeline update.
TXT

git commit -am "main: tighten chapter three" >/dev/null

git rev-parse HEAD > /challenge/.resolve_main_before_merge
git rev-parse feature/story > /challenge/.resolve_feature_head

chown -R hacker:hacker /home/hacker/dojo-conflict

git config --global --add safe.directory /home/hacker/dojo-conflict

source /mnt/site-packages/setup_packages.sh
/mnt/sudo/setup.sh