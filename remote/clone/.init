#!/bin/bash

set -eou pipefail

mkdir -p /opt
: > /opt/.init.stdout
: > /opt/.init.stderr
chmod 644 /opt/.init.stdout /opt/.init.stderr

# Redirect all stdout/stderr of this script (and child processes) to files.
exec 1>/opt/.init.stdout 2>/opt/.init.stderr

chmod +x /challenge/submit

# Setup the git proxy:
# https://github.com/acm-dojo/git-sample-repo.git -> /opt/git-sample-repo/

mv /challenge/git-sample-repo /opt/git-sample-repo
mv /opt/git-sample-repo/.raw.git /opt/git-sample-repo/.git  # unfreeze the repo
chown hacker:hacker -R /opt/git-sample-repo/

/run/dojo/bin/git config --system 'url."/opt/git-sample-repo/".insteadOf' 'https://github.com/acm-dojo/git-sample-repo'
/run/dojo/bin/git config --system 'url."/opt/git-sample-repo/".insteadOf' 'git@github.com:acm-dojo/git-sample-repo'

/mnt/site-packages/setup_packages.sh
/mnt/sudo/setup.sh