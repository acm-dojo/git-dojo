#!/bin/bash

set -eou pipefail

mkdir -p /opt
: > /opt/.init.stdout
: > /opt/.init.stderr
chmod 644 /opt/.init.stdout /opt/.init.stderr

chmod +x /challenge/submit

# Setup the git proxy:
# https://github.com/acm-dojo/git-sample-repo.git -> /opt/git-sample-repo/

export PATH="/run/dojo/bin:$PATH"
mv /challenge/git-sample-repo/.raw.git /challenge/git-sample-repo/.git  # unfreeze the repo
git clone --bare /challenge/git-sample-repo /opt/git-sample-repo
chown hacker:hacker -R /opt/git-sample-repo/
rm -rf /challenge/git-sample-repo  # clean up

cat > /etc/gitconfig <<'EOF'
[url "/opt/git-sample-repo/"]
    insteadOf = https://github.com/acm-dojo/git-sample-repo
    insteadOf = git@github.com:acm-dojo/git-sample-repo
EOF

source /mnt/site-packages/setup_packages.sh
/mnt/sudo/setup.sh